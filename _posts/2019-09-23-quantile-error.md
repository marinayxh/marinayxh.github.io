---
title: "Quantile Error Simulation"
date: 2019-09-23
permalink: /quantile-error-sim/
excerpt: "Simulation Study"
---


## Common Requirement for all the distribution below


1. The sampling distribution for the quantiles is generated by repeatedly calculating the quantiles from random samples of size N. In this assignment let N=200. Calculate the length of the middle 95% of the sampling distribution by calculating the difference between 2.5% and 97.5% percentiles of the sampling distribution. Your empirical sampling distribution should be at least 5000 draws.

2. The x-axis is a transformation of the x-values in the previous figure. You will calculate the density (relative likelihood) corresponding to the pt**h quantiles from the previous figure.

## Distributions


### Distribution 1: The Standard Normal Distribution

_Figure of the Length of middle 95% of sampling distribution_

Here we could see that between 0.4 and 0.6 quantile, the middle 95% sampling distribution gets dense and hits the lowest point, which means a more precisely estimation happened here. The overall graph is concaved up. 

```r
p <- seq(0.05, 0.95, by = 0.05)

quantiles_snd <- matrix(NA,nrow = 5000,ncol = 19)

for (i in 1:5000) {
  snd <- rnorm(200)
  for (j in 1:19) {
    quantiles_snd[i,j] <- quantile(snd,0.05*j)   #[i][j]: for list (can be 3D or 4D), [i,j]: for matrix and data frame
    j <- j+1
  }
  i<-i+1
}

mid.lengths <- rep(NA,19)

for (i in 1:19) {
  mid.lengths[i] <- quantile(quantiles_snd[,i],0.975)-quantile(quantiles_snd[,i],0.025)
}

plot(p,mid.lengths, xlab = "pth quantile", ylab = "Length", main = "Length of middle 95% of sampling distribution", type = "b")

# customerize the x axes: set axes = F inside the plot function, then add another line of code: axis(1, at = seq(.05,.95,by = .1))

```
![](/images/quantile1.PNG)



_Figure of the length of the middle 95% of the sampling distribution by density_

Here we could see that the overall distribution is showing a negative relationship between the two variables, which means a higher density has a lower length. There are two density points for the same length because, from the sampling distribution (the first graph), we could see that for the left tail and right tail, there are some points have the same slope/density.

```r
# Requirement 2
plot(dnorm(qnorm(p)),mid.lengths, xlab = "Density", ylab = "Length", main = "Length of the middle 95% of the sampling distribution by density", type = "p")

```
![](/images/quantile2.PNG)



### Distribution 2: The exponential distribution with rate = 1.

_Figure of the Length of middle 95% of sampling distribution_

Here we could see for the exponential distribution (with rate = 1), the middle 95% sampling distribution shows an increasing exponential distribution shape. Length range gets bigger for this distribution.

```r
# Requirement 1
quantiles_ed <- matrix(NA,nrow = 5000,ncol = 19)

for (i in 1:5000) {
  ed <- rexp(200, rate = 1)
  for (j in 1:19) {
    quantiles_ed[i,j] <- quantile(ed,0.05*j)  
    j <- j+1
  }
  i<-i+1
}

ed.mid.lengths <- rep(NA,19)

for (i in 1:19) {
  ed.mid.lengths[i] <- quantile(quantiles_ed[,i],0.975)-quantile(quantiles_ed[,i],0.025)
}

plot(p,ed.mid.lengths, xlab = "pth quantile", ylab = "Length", main = "Length of middle 95% of sampling distribution", type = "b")
```
![](/images/quantile3.PNG)



_Figure of the length of the middle 95% of the sampling distribution by density_

Here we could see that for this distribution, it is not shown clear which point is most densed. 
```r
# Requirement 2
plot(dexp(qexp(p)),ed.mid.lengths, xlab = "Density", ylab = "Length", main = "Length of the middle 95% of the sampling distribution by density", type = "p")
```
![](/images/quantile4.PNG)



### Distribution 3: Mixture distribution I (Given the following code)

      rf3 <- function(N){
        G <- sample(0:2, N, replace = TRUE, prob = c(5,3,2))
        (G==0)*rnorm(N) + (G==1)*rnorm(N,4) + (G==2)*rnorm(N,-4,2)
      }
      
      pf3 <- function(x){
        .5*pnorm(x) + .3*pnorm(x,4) + .2*pnorm(x,-4,2)
      }
      
      df3 <- function(x){
        .5*dnorm(x) + .3*dnorm(x,4) + .2*dnorm(x,-4,2)
      }

_Figure of the Length of middle 95% of sampling distribution_

Here we could see for this mixture distribution. There are two peaks when probability is about 0.2 and 0.7. We also can find that when quantile hits to about 0.4, it is more dense. The range of the length is getting bigger here.

```r
# Requirement 1

rf3 <- function(N){
  G <- sample(0:2, N, replace = TRUE, prob = c(5,3,2))
  (G==0)*rnorm(N) + (G==1)*rnorm(N,4) + (G==2)*rnorm(N,-4,2)
}

pf3 <- function(x){
  .5*pnorm(x) + .3*pnorm(x,4) + .2*pnorm(x,-4,2)
}

df3 <- function(x){
  .5*dnorm(x) + .3*dnorm(x,4) + .2*dnorm(x,-4,2)
}


roots<-rep(NA, 19)

quantiles_mix3 <- matrix(NA,nrow = 5000,ncol = 19)

for (i in 1:5000) {
  mix3 <- rf3(200)
  for (j in 1:19) {
    quantiles_mix3[i,j] <- quantile(mix3,0.05*j)
    j <- j+1
  }
  i<-i+1
}

mix3.mid.lengths <- rep(NA,19)

for (i in 1:19) {
  mix3.mid.lengths[i] <- quantile(quantiles_mix3[,i],0.975)-quantile(quantiles_mix3[,i],0.025)
}



for(i in 1:length(p)){
  pnew<-function(q){
  pf3(q)-p[i]
}

roots[i]<-uniroot(pnew, c(-100,100))[[1]]
}

# Prob 
plot(p, mix3.mid.lengths, xlab = "pth quantile", ylab = "Length", main = "Length of middle 95% of sampling distribution by probability", type = "b")
```
![](/images/quantile5.PNG)

```r
# Quant
plot(roots, mix3.mid.lengths, xlab = "Probability", ylab = "Length", main = "Length of middle 95% of sampling distribution", type = "b")
```
![](/images/quantile6.PNG)



_Figure of the length of the middle 95% of the sampling distribution by density_

Here we could see that the overall trend is going down between these two variables, but the points are kind of everywhere.

```r
# Requirement 2
#Density
plot(df3(roots),mix3.mid.lengths, xlab = "Density", ylab = "Length", main = "Length of the middle 95% of the sampling distribution by density", type = "p")
```
![](/images/quantile7.PNG)



### Distribution 4: Mixture distribution II (Given the following code)

      rf4 <- function(N){
        G <- sample(0:1, N, replace = TRUE)
        (G==0)*rbeta(N,5,1) + (G==1)*rbeta(N,1,5)
      }

_Figure of the Length of middle 95% of sampling distribution_

Here we could see for this mixture distribution; it has a normal distribution sampling. Here, it shows least precise when quantile hits the peak: look at how many points appearing, and the peak has the least. The range of the length is the smallest between these distributions.

```r
# Requirement 1

rf4 <- function(N){
  G <- sample(0:1, N, replace = TRUE)
  (G==0)*rbeta(N,5,1) + (G==1)*rbeta(N,1,5)
}


roots_4<-rep(NA, 19)

quantiles_mix4 <- matrix(NA,nrow = 5000,ncol = 19)

for (i in 1:5000) {
  mix4 <- rf4(200)
  for (j in 1:19) {
    quantiles_mix4[i,j] <- quantile(mix4,0.05*j)
    j <- j+1
  }
  i<-i+1
}

mix4.mid.lengths <- rep(NA,19)

for (i in 1:19) {
  mix4.mid.lengths[i] <- quantile(quantiles_mix4[,i],0.975)-quantile(quantiles_mix4[,i],0.025)
}


# Quant
plot(p, mix4.mid.lengths, xlab = "pth quantile", ylab = "Length", main = "Length of middle 95% of sampling distribution", type = "b")
```
![](/images/quantile8.PNG)



_Figure of the length of the middle 95% of the sampling distribution by density_

Here we could see that the overall trend is going down between these two variables. The range of the density is also larger: larger density number means better precision.

```r
# Requirement 2
#Density
pf4<-function(x){
  0.5*pbeta(x,5,1)+0.5*pbeta(x,1,5)
}
x_density_4<-rep(NA,19)
df4_1<-rep(NA,19)

for( i in 1:19){
  f4<-function(x){0.5*pbeta(x,5,1)+0.5*pbeta(x,1,5)-p[i]}
  x_density_4[i]<-uniroot(f4, lower = -200, upper = 200)
}  

df4 <- function(x){
  0.5*dbeta(x,5,1)+0.5*dbeta(x,1,5)
}
for (i in seq_along(x_density_4)){
df4_1[i] <-df4(x_density_4[[i]])
}
plot(df4_1,mix4.mid.lengths,xlab="Density",ylab="Length",main="Length of the middle 95% of the sampling distribution by density", type = "p")
```
![](/images/quantile9.PNG)



## Questions


1. Which quantiles have more precision? less precision?

For the first distribution, we can see that when pth quantile hits in range 0.4 to 0.6, the length of the middle 95% has the smallest value, which means that between 40th quantile and 60th quantile, for this distribution, the median has more precision. When the pth quantile less than about 0.1 or higher than about 0.9, we could see that points are loose, and the length is high for either situation. For the second distribution, we can see that when the pth quantile is higher than about 0.9, the points are loose and length value is high, which means that here the quantile has less precision. In the other hand, we can see that when pth quantile is less than about 0.1, the length of the middle 95% has the smallest value, which means that inside of this range, the quantile has more precision. For the third distribution, we can see that when pth quantile hits to about 0.4, the points are dense and the length value is relatively small, which means that around 40th quantile has more precision. In the other hand, when pth quantile hits to 0.1, points are loose, and the length value is high which means about 10th quantile has less precision. For the fourth distribution,  we can see that when pth quantile hits to 0.5, the points are loose and length value is high which means that the 50th quantile has less precision. In the other hand, 10th and 90th quantile have more precision since points are dense here and the length value is low. 


2. When does the median have the tightest sampling distribution?

For the first distribution, we can see that when the pth quantile hits to 0.5, the length of the middle 95% of the sampling distribution is nearly around 0.35 and points are dense compared to other distribution. We can also see the density here is the highest among other quantiles. Thus, the median in the first distribution has the tightest sampling distribution. 


3. Select a distribution and create a figure similar to the first one above, adding additional lines for N=400, 800, 1600. Explain how the information in the figure might be used when planning data collection and data analysis.

The limit of length is changing while N is changing. We need a larger size of N if we want a better and more precisely estimation. 


Normal Standard Distribution has been used for this one:

```r

size <- function(N){
  quantiles_diff_size <- matrix(NA,nrow = 5000,ncol = 19)

for (i in 1:5000) {
  snd_diff_size <- rnorm(N)
  for (j in 1:19) {
    quantiles_diff_size[i,j] <- quantile(snd_diff_size,0.05*j)   
    j <- j+1
  }
  i<-i+1
}

  
mid.lengths_diff_size <- rep(NA,19)

for (i in 1:19) {
  mid.lengths_diff_size[i] <- quantile(quantiles_diff_size[,i],0.975)-quantile(quantiles_diff_size[,i],0.025)
}
return(mid.lengths_diff_size)
}

set <- matrix(c(size(400),size(800),size(1600)),nrow = length(size(400)))

matplot(set, type = "l",ylim = c(),xlab = "Pth quantile",ylab = "Length", main = "Length of the middle 95% of the normal sampling distribution by different sample size")
legend("topleft", legend=c("size = 400", "size = 800", "size = 1600" ), col=c("black", "red", "green"), lty=1:2, cex=0.8)

```
![](/images/quantile10.PNG)